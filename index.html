<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />

<!-- ======== Google Analytics ======== -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-DM82T7W6EC"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){ dataLayer.push(arguments); }
  gtag('js', new Date());
  gtag('config', 'G-DM82T7W6EC');
</script>

<script>
/* ==========================
      UTM + DEVICE + GEO PRO TRACKER
   ========================== */

function getQueryParams() {
  const params = {};
  const queryString = window.location.search.substring(1).split("&");
  queryString.forEach(pair => {
    const [key, value] = pair.split("=");
    if (key) params[key] = decodeURIComponent(value || "");
  });
  return params;
}

function detectDevice() {
  const ua = navigator.userAgent || navigator.vendor || window.opera;
  if (/android/i.test(ua)) return "android";
  if (/iPad|iPhone|iPod/.test(ua)) return "ios";
  return "desktop";
}

// country detection using browser locale
function detectCountry() {
  try {
    return Intl.DateTimeFormat().resolvedOptions().locale.split("-")[1] || "unknown";
  } catch {
    return "unknown";
  }
}

// send event safely
function sendEvent(name, params = {}) {
  gtag('event', name, params);
}

function performRedirect(device) {
  let target = "";

  if (device === "android") {
    target = "https://play.google.com/store/apps/details?id=com.StepNlevel.MoleculMerge";
    sendEvent("redirect_to_android");
  } else if (device === "ios") {
    target = "https://apps.apple.com/app/id6753990749";
    sendEvent("redirect_to_ios");
  } else {
    target = "https://t.me/chto_za_igra";
    sendEvent("redirect_desktop");
  }

  // Safe delay so GA4 sends all events
  setTimeout(() => { window.location.href = target; }, 350);
}

window.onload = function() {
  const utm = getQueryParams();
  const device = detectDevice();
  const country = detectCountry();
  const language = navigator.language || "unknown";
  const referrer = document.referrer || "none";

  // 1) Send UTM event
  sendEvent("utm_detected", utm);

  // 2) General landing event with all parameters
  sendEvent("landing_page_opened", {
    device: device,
    country: country,
    language: language,
    referrer: referrer,
    full_url: window.location.href,
    utm_source: utm.utm_source || "none",
    utm_medium: utm.utm_medium || "none",
    utm_campaign: utm.utm_campaign || "none"
  });

  // 3) Device event
  sendEvent("device_type", { device: device });

  // 4) Country event
  sendEvent("country_detected", { country: country });

  // 5) Redirect user
  performRedirect(device);
};
</script>

</head>
<body>
Redirecting...
</body>
</html>

