<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Molecul Merge - Redirecting...</title>
<!-- ======== Google Analytics ======== -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-DM82T7W6EC"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){ dataLayer.push(arguments); }
  gtag('js', new Date());
  gtag('config', 'G-DM82T7W6EC');
</script>
<script>
/* ==========================
      UTM + DEVICE + GEO PRO TRACKER (УЛУЧШЕННАЯ ВЕРСИЯ)
   ========================== */
function getQueryParams() {
  const params = {};
  const queryString = window.location.search.substring(1).split("&");
  queryString.forEach(pair => {
    const [key, value] = pair.split("=");
    if (key) params[key] = decodeURIComponent(value || "");
  });
  return params;
}

function detectDevice() {
  const ua = navigator.userAgent || navigator.vendor || window.opera;
  
  // Android detection
  if (/android/i.test(ua)) return "android";
  
  // iOS detection (iPhone, iPod, старые iPad)
  if (/iPhone|iPod/.test(ua)) return "ios";
  if (/iPad/.test(ua)) return "ios";
  
  // Новые iPad (iPadOS 13+) - несколько способов проверки
  const isMacOS = /Macintosh|MacIntel|MacPPC|Mac68K/i.test(ua);
  const hasTouch = navigator.maxTouchPoints && navigator.maxTouchPoints > 1;
  
  // Дополнительная проверка: iPad имеет определенное соотношение сторон
  const isTabletScreen = window.screen.width >= 768 && window.screen.width <= 1024;
  
  if (isMacOS && (hasTouch || isTabletScreen)) return "ios";
  
  return "desktop";
}

function detectCountry() {
  try {
    return Intl.DateTimeFormat().resolvedOptions().locale.split("-")[1] || "unknown";
  } catch {
    return "unknown";
  }
}

function sendEvent(name, params = {}) {
  gtag('event', name, params);
}

function performRedirect(device) {
  let target = "";
  if (device === "android") {
    target = "https://play.google.com/store/apps/details?id=com.StepNlevel.MoleculMerge";
    sendEvent("redirect_to_android");
  } else if (device === "ios") {
    target = "https://apps.apple.com/app/id6753990749";
    sendEvent("redirect_to_ios");
  } else {
    target = "https://t.me/chto_za_igra";
    sendEvent("redirect_desktop");
  }
  
  setTimeout(() => { window.location.href = target; }, 350);
}

window.onload = function() {
  const utm = getQueryParams();
  const device = detectDevice();
  const country = detectCountry();
  const language = navigator.language || "unknown";
  const referrer = document.referrer || "none";
  
  // ✅ УЛУЧШЕНИЕ 1: Отправляем UTM как отдельные параметры (для удобства в GA4)
  gtag('event', 'page_view', {
    page_title: 'Molecul Merge Redirect',
    page_location: window.location.href,
    // UTM параметры
    campaign_source: utm.utm_source || '(direct)',
    campaign_medium: utm.utm_medium || '(none)',
    campaign_name: utm.utm_campaign || '(not set)',
    campaign_content: utm.utm_content || '(not set)',
    campaign_term: utm.utm_term || '(not set)',
    // Дополнительные параметры
    device_category: device,
    user_country: country,
    user_language: language,
    traffic_referrer: referrer
  });
  
  // ✅ УЛУЧШЕНИЕ 2: Отдельное событие для каждого источника трафика
  if (utm.utm_source) {
    sendEvent('traffic_source', {
      source: utm.utm_source,
      medium: utm.utm_medium || 'unknown',
      campaign: utm.utm_campaign || 'unknown'
    });
  }
  
  // ✅ УЛУЧШЕНИЕ 3: Событие для социальных сетей
  const socialNetworks = ['instagram', 'facebook', 'tiktok', 'youtube', 'twitter', 'vk', 'telegram'];
  if (socialNetworks.includes(utm.utm_source?.toLowerCase())) {
    sendEvent('social_media_visit', {
      platform: utm.utm_source,
      campaign: utm.utm_campaign || 'organic'
    });
  }
  
  // Остальные события
  sendEvent("device_type", { device: device });
  sendEvent("country_detected", { country: country });
  
  // Редирект
  performRedirect(device);
};
</script>
<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
  display: flex;
  align-items: center;
  justify-content: center;
  height: 100vh;
  margin: 0;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
}
.loader {
  text-align: center;
}
.spinner {
  border: 4px solid rgba(255,255,255,0.3);
  border-top: 4px solid white;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  animation: spin 1s linear infinite;
  margin: 0 auto 20px;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>
</head>
<body>
<div class="loader">
  <div class="spinner"></div>
  <h2>Molecul Merge</h2>
  <p>Redirecting to your platform...</p>
</div>
</body>
</html>
